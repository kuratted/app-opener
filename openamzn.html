<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="robots" content="noindex">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opening Amazon App…</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:24px; text-align:center; }
    h3 { margin: 0 0 8px; font-weight: 600; }
    p { margin: 0 0 20px; opacity: .75; }
    .actions { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button {
      appearance: none; border: 0; border-radius: 999px; padding: 12px 18px;
      font-weight: 600; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    .primary { background: #ffd814; }
    .secondary { background: #e6e6e6; }
    small { display:block; margin-top:14px; opacity:.6; }
  </style>
  <script>
    // -----------------------------
    // CONFIG
    // -----------------------------
    const AMAZON_AFF_TAG = "collab-ks-21"; // change if needed
    const ENFORCE_TAG = true;              // set false if you DON'T want to inject tag when missing

    // -----------------------------
    // URL EXTRACTION FROM URL BAR
    // -----------------------------
    function getSearchParams(url) {
      try { return new URL(url).searchParams; } catch { return new URLSearchParams(); }
    }

    function safeDecode(str) {
      try { return decodeURIComponent(str); } catch { return str; }
    }

    function tryBase64Decode(str) {
      try {
        if (!/^[A-Za-z0-9+/=]+$/.test(str) || str.length % 4 !== 0) return str;
        const decoded = atob(str);
        if (/^https?:\/\//i.test(decoded) || /^www\./i.test(decoded)) return decoded;
        return str;
      } catch { return str; }
    }

    function extractFromPrettyPath() {
      const path = location.pathname || "";
      const parts = path.split("/").filter(Boolean);
      if (parts.length >= 2 && /^(go|r|redirect)$/i.test(parts[0])) {
        return parts.slice(1).join("/"); // allow slashes in payload
      }
      return null;
    }

    function collectCandidateStrings() {
      const href = location.href;
      const sp = getSearchParams(href);
      const hash = (location.hash || "").replace(/^#/, "");
      const hashParams = new URLSearchParams(hash);

      const keys = ["url","u","link","l","redirect","r","target","to","q"]; // common keys
      const candidates = [];

      // query params
      keys.forEach(k => { const v = sp.get(k); if (v) candidates.push(v); });
      // hash params (#url=...)
      keys.forEach(k => { const v = hashParams.get(k); if (v) candidates.push(v); });

      // obvious http(s) substring from the full href
      const urlMatch = href.match(/https?:\/\/[^\s"'<>]+/i);
      if (urlMatch) candidates.push(urlMatch[0]);

      // pretty path
      const pretty = extractFromPrettyPath();
      if (pretty) candidates.push(pretty);

      // de-dup while preserving order
      return [...new Set(candidates.filter(Boolean))];
    }

    function normalizeToUrl(raw) {
      if (!raw) return null;
      raw = raw.trim().replace(/^['"]|['"]$/g, "");

      let decoded = safeDecode(raw);
      decoded = tryBase64Decode(decoded);
      decoded = safeDecode(decoded);

      // add scheme if missing
      if (!/^https?:\/\//i.test(decoded)) {
        if (/^www\./i.test(decoded)) decoded = "https://" + decoded;
      }

      try {
        const u = new URL(decoded);
        return u.href;
      } catch {
        return null;
      }
    }

    function pickMainUrl() {
      const candidates = collectCandidateStrings();
      for (const c of candidates) {
        const u = normalizeToUrl(c);
        if (!u) continue;
        if (/\/\/([a-z0-9-]+\.)*amazon\./i.test(u)) return u; // prefer Amazon
      }
      for (const c of candidates) {
        const u = normalizeToUrl(c);
        if (u) return u;
      }
      return null;
    }

    // -----------------------------
    // AMAZON NORMALIZATION + TAG
    // -----------------------------
    function ensureAmazonAffiliateTag(urlStr) {
      try {
        const u = new URL(urlStr);
        const isAmazon = /(^|\.)amazon\./i.test(u.hostname);
        if (!isAmazon) return urlStr;

        if (!u.searchParams.has("tag") && ENFORCE_TAG && AMAZON_AFF_TAG) {
          u.searchParams.set("tag", AMAZON_AFF_TAG);
        }
        return u.toString();
      } catch {
        return urlStr;
      }
    }

    // -----------------------------
    // DEVICE / BROWSER HELPERS
    // -----------------------------
    function detectDevice() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      if (/android/i.test(ua)) return "android";
      if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return "ios";
      return "desktop";
    }
    function pickAmazonAndroidPackage(hostname) {
      const isIN = /\.amazon\.in$/i.test(hostname) || /(^|\.)amazon\.in$/i.test(hostname);
      return isIN ? "in.amazon.mShop.android.shopping" : "com.amazon.mShop.android.shopping";
    }

    // -----------------------------
    // INTENT / SCHEMES
    // -----------------------------
    function buildAndroidAppIntent(mainUrl) {
      const u = new URL(mainUrl);
      const pkg = pickAmazonAndroidPackage(u.hostname);
      const noScheme = mainUrl.replace(/^https?:\/\//i, "");
      // Single-shot: try Amazon app; if not installed most browsers show a chooser/Play fallback
      // (No timers or extra fallbacks here)
      return `intent://${noScheme}#Intent;scheme=https;package=${pkg};end`;
    }

    function buildAndroidChromeIntent(mainUrl) {
      const noScheme = mainUrl.replace(/^https?:\/\//i, "");
      // Explicitly open Chrome with the https scheme
      return `intent://${noScheme}#Intent;scheme=https;package=com.android.chrome;end`;
    }

    function buildIosAppScheme(mainUrl) {
      // Amazon app scheme for iOS
      return "com.amazon.mobile.shopping.web://" + mainUrl.replace(/^https?:\/\//i, "");
    }

    // -----------------------------
    // MAIN FLOW (no timers)
    // -----------------------------
    let mainUrl; // resolved target
    let started = false;

    function resolveUrlOnce() {
      if (mainUrl) return mainUrl;
      mainUrl = ensureAmazonAffiliateTag(pickMainUrl() || "https://www.amazon.in/");
      return mainUrl;
    }

    function openAmazonApp() {
      const url = resolveUrlOnce();
      const device = detectDevice();

      if (started) return; // prevent double firing on weird reloads
      started = true;

      if (device === "android") {
        location.href = buildAndroidAppIntent(url);
      } else if (device === "ios") {
        location.href = buildIosAppScheme(url);
      } else {
        // desktop fallback: just open the site
        location.replace(url);
      }
    }

    function openChromeOnAndroid() {
      const url = resolveUrlOnce();
      const device = detectDevice();
      if (device === "android") {
        location.href = buildAndroidChromeIntent(url);
      } else {
        // Non-Android: just go to web
        location.replace(url);
      }
    }

    // Optional: attempt one immediate open without timers.
    // Comment this out if you want ONLY manual button behavior.
    window.addEventListener("load", () => {
      // Try once silently; if it doesn't work, buttons are visible for manual retry.
      openAmazonApp();
      // allow manual retries afterward
      started = false;
    }, { once: true });
  </script>
</head>
<body>
  <h3>Opening Amazon App…</h3>
  <p>If it doesn’t open, use the button below.</p>

  <div class="actions">
    <button class="primary" onclick="openAmazonApp()">Open Amazon App</button>
    <button class="secondary" onclick="openChromeOnAndroid()">Open in Chrome (Android)</button>
  </div>

  <small>This page won’t auto-redirect after a delay.</small>
</body>
</html>
