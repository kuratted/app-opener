<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="robots" content="noindex">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Redirecting...</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:16px; text-align:center; }
    #log { margin-top:12px; color:#444; white-space:pre-wrap; font-size:14px; }
    .pb { position:fixed; bottom:1em; left:0; right:0; font-size:12px; color:#bbb; }
    .pb a { color:#d3d3d3; text-decoration:none; }
    button { padding:12px 18px; font-size:16px; margin-top:18px; }
  </style>
</head>
<body>
  <h3>Opening the app…</h3>
  <div id="log"></div>
  <button id="retryBtn" style="display:none">Try Again</button>
  <p class="pb"><a href="https://linktw.in/?reff=poweredby">POWERED BY LINKTW.IN</a></p>

  <script>
    /* =================== CONFIG =================== */
    const DEFAULT_URL = "https://www.flipkart.com/";
    const APPS = {
      flipkart: {
        test: /(^|\.)flipkart\.com$/i,
        schemePrefix: "flipkart://",
        androidPackage: "com.flipkart.android",
        iosStoreUrl: "https://apps.apple.com/in/app/flipkart-shop-online/id742044692"
      },
      amazon: {
        test: /(^|\.)amazon\.(in|com|ae|de|co\.uk|ca|com\.au|fr|it|es|nl|sg|jp)$/i,
        schemePrefix: "com.amazon.mobile.shopping.web://",
        androidPackage: "com.amazon.mShop.android.shopping",
        iosStoreUrl: "https://apps.apple.com/in/app/amazon-shopping/id297606951"
      },
      myntra: {
        test: /(^|\.)myntra\.com$/i,
        schemePrefix: "myntra://",
        androidPackage: "com.myntra.android",
        iosStoreUrl: "https://apps.apple.com/in/app/myntra-fashion-shopping-app/id907394059"
      }
    };
    /* ============================================= */

    function log(...args){ document.getElementById('log').textContent += args.join(' ') + "\n"; }
    function ua(){ return navigator.userAgent || navigator.vendor || window.opera || ""; }
    function isAndroid(){ return /Android/i.test(ua()); }
    function isIOS(){ return /iPad|iPhone|iPod/i.test(ua()) && !window.MSStream; }
    function isInstagram(){ return /Instagram/i.test(ua()); }
    function isMobileSafari(){ return /iP(hone|od|ad).+Safari/i.test(ua()) && !/CriOS|FxiOS/i.test(ua()); }

    function getQueryParam(name){
      const sp = new URLSearchParams(location.search);
      return sp.get(name);
    }

    // ✅ auto-encode a URL
    function autoEncodeUrl(u){
      try {
        // First decode if already encoded
        let decoded = decodeURIComponent(u);
        return encodeURI(decoded);
      } catch {
        // fallback: just encode directly
        return encodeURI(u);
      }
    }

    function cleanUrl(raw){
      if (!raw) return "";
      raw = raw.trim();
      try {
        // decode once if percent-encoded
        try {
          const maybe = decodeURIComponent(raw);
          if (/^(https?:\/\/|[a-z]+:\/\/)/i.test(maybe)) raw = maybe;
        } catch(e){}
        if (!/^(https?:\/\/|[a-z]+:\/\/)/i.test(raw)) raw = "https://" + raw;
        const parsed = new URL(raw);
        return parsed.toString();
      } catch(e){ return ""; }
    }

    function extractTarget(){
      const raw = getQueryParam("u") || getQueryParam("url");
      const cleaned = cleanUrl(raw);
      if (cleaned) { 
        const encoded = autoEncodeUrl(cleaned);
        log("Extracted and encoded URL:", encoded); 
        return encoded; 
      }
      log("No ?u= provided. Using default:", DEFAULT_URL);
      return DEFAULT_URL;
    }

    function detectAppMeta(target){
      try {
        const host = new URL(target).hostname.toLowerCase();
        for (const key in APPS){
          if (APPS[key].test.test(host)) return APPS[key];
        }
      } catch(e){}
      return null;
    }

    function stripProtocol(u){ return u.replace(/^https?:\/\//i, ""); }

    const targetUrl = extractTarget();
    const appMeta = detectAppMeta(targetUrl);
    const device = isAndroid() ? "android" : (isIOS() ? "ios" : "desktop");
    let appDeepLink = null;

    if (appMeta && /^https?:\/\//i.test(targetUrl)) {
      appDeepLink = appMeta.schemePrefix + stripProtocol(targetUrl);
    } else if (/^[a-z]+:\/\//i.test(targetUrl)) {
      appDeepLink = targetUrl;
    }

    function openNow(){
      if (isInstagram() && isIOS()) {
        log("Instagram iOS detected — trying to open in Safari.");
        const a = document.createElement('a');
        a.href = targetUrl; a.target = "_blank"; a.rel = "noopener";
        document.body.appendChild(a); a.click(); a.remove();
        document.getElementById("retryBtn").style.display = "inline-block";
        return;
      }

      if (device === "desktop") {
        log("Desktop detected — opening web URL.");
        location.replace(targetUrl);
        return;
      }

      let attemptedScheme = false;
      if (appDeepLink) {
        attemptedScheme = true;
        log("Trying app deep link:", appDeepLink);
        try { window.location = appDeepLink; } catch(e){}
      }

      if (device === "android") {
        const pkg = appMeta && appMeta.androidPackage ? `;package=${appMeta.androidPackage}` : "";
        const intent = "intent:" + stripProtocol(targetUrl) +
                       "#Intent;action=android.intent.action.VIEW" +
                       pkg +
                       ";S.browser_fallback_url=" + encodeURIComponent(targetUrl) +
                       ";end";
        setTimeout(() => { log("Android intent fallback:", intent); window.location = intent; }, attemptedScheme ? 450 : 0);
        setTimeout(() => { log("Final web fallback:", targetUrl); window.location = targetUrl; }, 1100);
        return;
      }

      if (device === "ios") {
        const store = appMeta ? appMeta.iosStoreUrl : null;
        setTimeout(() => {
          if (document.visibilityState === "hidden") return;
          if (store) {
            log("iOS App Store fallback:", store);
            window.location = store;
          } else {
            log("iOS web fallback:", targetUrl);
            window.location = targetUrl;
          }
        }, attemptedScheme ? 1200 : 600);

        setTimeout(() => {
          if (document.visibilityState === "hidden") return;
          log("Final web fallback:", targetUrl);
          window.location = targetUrl;
        }, 2000);
        return;
      }
    }

    window.addEventListener('load', openNow);
    document.getElementById('retryBtn').addEventListener('click', openNow);
  </script>
</body>
</html>
